# Architecture Diagram

[![](https://mermaid.ink/img/pako:eNp9VmtvskgU_isTkjex21a8VvTDJqJ9t6RWG7WaXXzTjDAqERgyA1p7-e97BgZErPVDy5zznPtl5kOxqE2UjrLwVy7dWxvMQjTVFz5Cv36h2-yHDH_FMHpmdOdwh_qOv85xBZxHyzXDwQYZ3Z45Cog_pasIqWhKGMMryjxk4N4fgURoOvr9YobAv3WEWkkdN-tmdz5BYxqFpFlHG8pDYqN36pPFwj9Qf70k1Cv7JJQCek2PrC0Jualja7t08TsBGlrCIQrQMuGlyjNsz6WRvXIxI0A8Bx89hAD_Fk4VKJnVIjJPJ76dqDrNYn84Qdfo3l6TQvYMPyQMIjPTD9RzHeJL90HMTLMiVDBiUWZzyEpX7cIPdO73e4RdB3OSBpFpEs6BlKBBNMej1CwInzgKN6rr-Fuu2szZETXYq0tM1WBDQ8pVn4ZQdHVXLSdfn-gBipOoyAovSOYDCd99wtDLMvLDCNUa5Uoj5sg69LBtH8z4L4SxI4wTFDD6doBgOlpF7TQaSeURuL6nbJuV5LFnPpKD5VK8BaxLLewKXKfWqDSk8sHcHEAMe8xs4hdBTQka9swheQst0Qaoa4yKuDuJm83NGY7c8HttLYka6XGz65gWEZpEGE-m4XmOtTkF1LR6FlqSDlGYx16RMpgXKcMzzOwMM9KLFOMptQYtuZWJRE7cJNjlaY6lF8__mKUU9BqAw2tG-NWfnAo3S3RRyWAuHRdKjrATNTnc070xMMySRxzX4QQza5MHlNHI6PdQWeYmM-_EKS2aNp5krMJ0Ajkzm2HGGYQR2ynynwam5HrY2jg-eXXBObH48lmgUHuYk6IfI11WYdz9PTUXSgqDTRiqLl2rK8claEfdyCN8oeQ1-llvFnQOe7L6_VHv8X4MWtUdZiqLfNWmsHhYmcM_VIKWRhSySHjIcEjZVaz_4krS4wXIL21zyQZryReaODaxMOOoBDkNHQt2D48CwiwGt4KVGhOtpJtpB90mWxYGoFLv1JrIxo4rBj5Yv9qRF4AK1cYhzsqum8e2OZFtVDJZHlLwGgfBtb28jpsny-IMFOyOo5vT0OjUihpywGykdVMW7Cj6l1ptIs8Re0AUEXEfBxyWY9Y0umyXE3-rR2ui4hwipYFYoNhFMnjsuqndoS5aZbWC4MltsmhR3vfKUVupAOMh4M4qLeZYDnS8D8RIytmMz_Ho5Qmzudwn8Snr4viUzY08SVXxOTEWwz-Ttvg8vSeLzJPLEoxfliwyTyRnP0nOfpKEoC5LFpknkhDwZckiMyd5PnoTEmAYUYJGspjDpJgTUUwYf7ggA3ppMEdDaJZvBUsBWIe3Q6rhBvHUkEU9WIfkOKUjuA2t-KWREbrPhim6DrroSHuZPpg76tjinZBRx_d9Y2KWTrYnKOz2-_-Cb1Z89ZTgzQDriUOHHmDlMXjFwAq9yu08KZG0Wnq3nRLBpW_J4FXOa0mNvToZg_iRU84mT7xmkBUxBlG7hzhLVFCS3MRXjbQT98Lwp0YZXii3cqOsmWMrnZBF5EbxCPOwOCofQmyhhBvikYXSgU-brMQKWsAT_AvEAuz_R6mXSkLC1pv0EAWwJknfwdACRwTESViPwntL6dS0RqxC6Xwob0pH08r1Wl1raa1Wu11pN7Ub5QCgulZu37VbzbtGo92uVtv1rxvlPTZaLd_VNK1Sq7XbwGpWq62v_wEsAdha?type=png)](https://mermaid.live/edit#pako:eNp9VmtvskgU_isTkjex21a8VvTDJqJ9t6RWG7WaXXzTjDAqERgyA1p7-e97BgZErPVDy5zznPtl5kOxqE2UjrLwVy7dWxvMQjTVFz5Cv36h2-yHDH_FMHpmdOdwh_qOv85xBZxHyzXDwQYZ3Z45Cog_pasIqWhKGMMryjxk4N4fgURoOvr9YobAv3WEWkkdN-tmdz5BYxqFpFlHG8pDYqN36pPFwj9Qf70k1Cv7JJQCek2PrC0Jualja7t08TsBGlrCIQrQMuGlyjNsz6WRvXIxI0A8Bx89hAD_Fk4VKJnVIjJPJ76dqDrNYn84Qdfo3l6TQvYMPyQMIjPTD9RzHeJL90HMTLMiVDBiUWZzyEpX7cIPdO73e4RdB3OSBpFpEs6BlKBBNMej1CwInzgKN6rr-Fuu2szZETXYq0tM1WBDQ8pVn4ZQdHVXLSdfn-gBipOoyAovSOYDCd99wtDLMvLDCNUa5Uoj5sg69LBtH8z4L4SxI4wTFDD6doBgOlpF7TQaSeURuL6nbJuV5LFnPpKD5VK8BaxLLewKXKfWqDSk8sHcHEAMe8xs4hdBTQka9swheQst0Qaoa4yKuDuJm83NGY7c8HttLYka6XGz65gWEZpEGE-m4XmOtTkF1LR6FlqSDlGYx16RMpgXKcMzzOwMM9KLFOMptQYtuZWJRE7cJNjlaY6lF8__mKUU9BqAw2tG-NWfnAo3S3RRyWAuHRdKjrATNTnc070xMMySRxzX4QQza5MHlNHI6PdQWeYmM-_EKS2aNp5krMJ0Ajkzm2HGGYQR2ynynwam5HrY2jg-eXXBObH48lmgUHuYk6IfI11WYdz9PTUXSgqDTRiqLl2rK8claEfdyCN8oeQ1-llvFnQOe7L6_VHv8X4MWtUdZiqLfNWmsHhYmcM_VIKWRhSySHjIcEjZVaz_4krS4wXIL21zyQZryReaODaxMOOoBDkNHQt2D48CwiwGt4KVGhOtpJtpB90mWxYGoFLv1JrIxo4rBj5Yv9qRF4AK1cYhzsqum8e2OZFtVDJZHlLwGgfBtb28jpsny-IMFOyOo5vT0OjUihpywGykdVMW7Cj6l1ptIs8Re0AUEXEfBxyWY9Y0umyXE3-rR2ui4hwipYFYoNhFMnjsuqndoS5aZbWC4MltsmhR3vfKUVupAOMh4M4qLeZYDnS8D8RIytmMz_Ho5Qmzudwn8Snr4viUzY08SVXxOTEWwz-Ttvg8vSeLzJPLEoxfliwyTyRnP0nOfpKEoC5LFpknkhDwZckiMyd5PnoTEmAYUYJGspjDpJgTUUwYf7ggA3ppMEdDaJZvBUsBWIe3Q6rhBvHUkEU9WIfkOKUjuA2t-KWREbrPhim6DrroSHuZPpg76tjinZBRx_d9Y2KWTrYnKOz2-_-Cb1Z89ZTgzQDriUOHHmDlMXjFwAq9yu08KZG0Wnq3nRLBpW_J4FXOa0mNvToZg_iRU84mT7xmkBUxBlG7hzhLVFCS3MRXjbQT98Lwp0YZXii3cqOsmWMrnZBF5EbxCPOwOCofQmyhhBvikYXSgU-brMQKWsAT_AvEAuz_R6mXSkLC1pv0EAWwJknfwdACRwTESViPwntL6dS0RqxC6Xwob0pH08r1Wl1raa1Wu11pN7Ub5QCgulZu37VbzbtGo92uVtv1rxvlPTZaLd_VNK1Sq7XbwGpWq62v_wEsAdha)

```mermaid
flowchart TB
  %% ---------- Infra Provisioning ----------
  subgraph IAC[OpenTofu / Terraform IaC]
    TOFU[tofu-infra]
    R53[AWS Route53 hosted zone\nyongbeom.net]
    B2Buckets[Backblaze B2 backup buckets]
    R2Buckets[Cloudflare R2 backup buckets]

    TOFU --> R53
    TOFU --> B2Buckets
    TOFU --> R2Buckets
  end

  %% ---------- DNS + Edge ----------
  Internet[Internet Clients]
  DNS[Route53 DNS records\nA/AAAA + www aliases]

  Internet --> DNS
  R53 --> DNS

  DNS -->|auth/links/drive/pw/bao/photos/notion/v1.notion| Host

  subgraph Host[Hetzner Ubuntu 24.04 Host]
    Caddy[Caddy reverse proxy\n:80/:443 host network]

    KC[Keycloak\nlocalhost:2404]
    LW[Linkwarden\nlocalhost:2405]
    NC[Nextcloud AIO\nlocalhost:2406]
    VW[Vaultwarden\nlocalhost:2407]
    OB[OpenBao\nlocalhost:2408]
    IM[Immich\nlocalhost:2283]

    Caddy --> KC
    Caddy --> LW
    Caddy --> NC
    Caddy --> VW
    Caddy --> OB
    Caddy --> IM

    %% keycloak internals
    KC --> KCPG[(keycloak_postgres)]

    %% linkwarden internals
    LW --> LWPG[(linkwarden_postgres)]
    LW --> MEILI[(meilisearch)]
    LW -. OIDC .-> KC

    %% immich internals
    IM --> IMPG[(immich_postgres)]
    IM --> IMR[(immich_redis)]
    IM --> ML[immich_machine_learning]

    %% openbao internals
    OB --> OBRAFT["openbao raft/log/file volumes"]

    %% nextcloud internals
    NC --> NCDOCKER["/var/run/docker.sock (AIO orchestrator)"]
  end

  %% ---------- Backups ----------
  subgraph Backups["Backup Sidecars (restic + supercronic)"]
    KCB[keycloak-backup\n03:25 daily\npg_dump + /data]
    LWB[linkwarden-backup\n03:40 daily\nstops app+db+meili]

    VWB[vaultwarden-backup\n04:20 daily\nstops vaultwarden]
    OBB[openbao-backup\n*/15 min\nraft snapshot]
    IMB[immich-backup\n03:10 daily\nfiles + optional pg_dumpall]
    ONB["offline-notion backup\n04:00 daily\n(offline-notion stack)"]
  end

  KCPG --> KCB
  LWPG --> LWB
  MEILI --> LWB
  VW --> VWB
  OB --> OBB
  IM --> IMB
  IMPG --> IMB

  KCB -->|restic| B2Buckets
  KCB -->|restic| R2Buckets
  LWB -->|restic| B2Buckets
  LWB -->|restic| R2Buckets
  VWB -->|restic| B2Buckets
  VWB -->|restic| R2Buckets
  OBB -->|restic| B2Buckets
  OBB -->|restic| R2Buckets
  IMB -->|restic| B2Buckets
  IMB -->|restic| R2Buckets

  %% ---------- Separate Offline-Notion Stack in repo ----------
  subgraph ON["Offline-Notion Stack (present in repo, separate compose)"]
    ONC[client]
    ONAPI[backend]
    ONAUTH[voidauth]
    ONREDIS[(redis)]
    ONCADDY["caddy (v1.docs style routing)"]

    ONCADDY --> ONC
    ONCADDY --> ONAPI
    ONCADDY --> ONAUTH
    ONAPI --> ONREDIS
  end

  DNS -. optional/not currently in root compose .-> ONCADDY
  ONB -->|restic| B2Buckets
  ONB -->|restic| R2Buckets
```

## Sources Used

- `yongbeom-hetzner-auction-ubuntu-2404/tofu-infra/main.tf`
- `yongbeom-hetzner-auction-ubuntu-2404/tofu-infra/aws-dns-record/dns.tf`
- `yongbeom-hetzner-auction-ubuntu-2404/tofu-infra/backup_bucket/main.tf`
- `yongbeom-hetzner-auction-ubuntu-2404/caddy/Caddyfile`
- `yongbeom-hetzner-auction-ubuntu-2404/docker-compose.yaml`
- `yongbeom-hetzner-auction-ubuntu-2404/{keycloak,linkwarden,nextcloud,vaultwarden,openbao,immich}/docker-compose.yaml`
- `yongbeom-hetzner-auction-ubuntu-2404/BACKUPS.md`
- `yongbeom-hetzner-auction-ubuntu-2404/*/backup/crontab`
- `yongbeom-hetzner-auction-ubuntu-2404/offline-notion/docker-compose.yml`
